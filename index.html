<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Leave Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #1f2937;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
        }

        .year-selector {
            background: #f9fafb;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .year-selector:hover {
            border-color: #9ca3af;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .right-panel {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            height: fit-content;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .card-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .team-icon {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .history-icon {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .card h2 {
            color: #111827;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .team-member {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .team-member:hover {
            background: #f9fafb;
            border-color: #e5e7eb;
        }

        .team-member.selected {
            background: #f3f4f6;
            border-color: #3b82f6;
        }

        .member-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            font-size: 0.9rem;
        }

        .member-details h3 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 2px;
            color: #111827;
        }

        .member-details p {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .leave-stats {
            text-align: right;
        }

        .days-left {
            font-size: 1.5rem;
            font-weight: 700;
            color: #059669;
        }

        .days-left-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 2px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .stat-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 16px;
        }

        .allowance-icon {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .taken-icon {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .remaining-icon {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: #111827;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #6b7280;
            font-weight: 500;
        }

        .progress-section {
            margin-bottom: 32px;
        }

        .progress-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }

        .progress-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #374151;
        }

        .progress-percentage {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .progress-bar {
            background: #e5e7eb;
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 8px;
            transition: width 0.5s ease;
        }

        .form-section h2 {
            color: #111827;
            margin-bottom: 24px;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #111827;
            color: white;
        }

        .btn-primary:hover {
            background: #1f2937;
        }

        .btn-secondary {
            background: #f9fafb;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #f3f4f6;
        }

        .add-person-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #111827;
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease;
        }

        .add-person-btn:hover {
            background: #1f2937;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .leave-history {
            margin-top: 20px;
        }

        .leave-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .leave-entry:hover {
            background: #f3f4f6;
        }

        .leave-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .leave-type-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .leave-dates {
            font-weight: 600;
            color: #111827;
            font-size: 0.9rem;
        }

        .leave-notes {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 2px;
        }

        .leave-duration {
            background: #111827;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            color: #6b7280;
            padding: 40px 20px;
            font-size: 0.9rem;
        }

        .empty-icon {
            width: 48px;
            height: 48px;
            background: #f3f4f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 20px;
            color: #9ca3af;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.5rem;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 32px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .modal h2 {
            margin-bottom: 24px;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .close-modal {
            position: absolute;
            top: 16px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            background: #f3f4f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-left">
                <div class="header-icon">üìÖ</div>
                <h1>Annual Leave Tracker</h1>
            </div>
        </header>

        <main class="main-content">
            <div class="left-panel">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon team-icon">üë•</div>
                        <h2>Team Members</h2>
                    </div>
                    <div id="teamMembers">
                        <!-- Team members will be populated here -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">üóìÔ∏è</div>
                        <h2>UAE Public Holidays</h2>
                    </div>
                    <div style="text-align: center; padding: 20px;">
                        <p style="color: #6b7280; margin-bottom: 16px; font-size: 0.9rem;">
                            Check the latest UAE public holidays and observances
                        </p>
                        <a href="https://www.timeanddate.com/holidays/united-arab-emirates/2025" 
                           target="_blank" 
                           rel="noopener noreferrer"
                           class="btn btn-primary"
                           style="display: inline-block; text-decoration: none;">
                            View UAE Holidays
                        </a>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon history-icon">üìã</div>
                        <h2>Leave History</h2>
                    </div>
                    <div class="leave-history" id="leaveHistory">
                        <!-- Leave entries will be populated here -->
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon allowance-icon">üìä</div>
                        <div class="stat-number" id="totalAllowance">25</div>
                        <div class="stat-label">Annual Allowance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon taken-icon">‚úàÔ∏è</div>
                        <div class="stat-number" id="daysTaken">0</div>
                        <div class="stat-label">Days Taken</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon remaining-icon">‚úÖ</div>
                        <div class="stat-number" id="daysRemaining">25</div>
                        <div class="stat-label">Days Remaining</div>
                    </div>
                </div>

                <div class="progress-section">
                    <div class="progress-header">
                        <span class="progress-label">Leave Usage</span>
                        <span class="progress-percentage" id="usagePercentage">0% used</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>

                <form class="form-section" id="leaveForm">
                    <h2>
                        <div class="form-icon">üìù</div>
                        Record New Leave
                    </h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" id="startDate" required>
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <input type="date" id="endDate" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="leaveType">Leave Type</label>
                        <select id="leaveType" required>
                            <option value="annual">Annual Leave</option>
                            <option value="sick">Sick Leave</option>
                            <option value="personal">Personal Leave</option>
                            <option value="maternity">Maternity/Paternity</option>
                            <option value="emergency">Emergency Leave</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes (Optional)</label>
                        <textarea id="notes" placeholder="Add any additional notes..."></textarea>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear</button>
                        <button type="submit" class="btn btn-primary">Record Leave</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <button class="add-person-btn" onclick="openAddPersonModal()">+</button>

    <!-- Add Person Modal -->
    <div class="modal" id="addPersonModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeAddPersonModal()">&times;</button>
            <h2>
                <div class="card-icon team-icon">üë§</div>
                Add Team Member
            </h2>
            <form id="addPersonForm">
                <div class="form-group">
                    <label for="personName">Full Name</label>
                    <input type="text" id="personName" required>
                </div>
                <div class="form-group">
                    <label for="personRole">Role</label>
                    <input type="text" id="personRole" placeholder="e.g., Software Engineer" required>
                </div>
                <div class="form-group">
                    <label for="annualAllowance">Annual Leave Allowance</label>
                    <input type="number" id="annualAllowance" value="25" min="0" max="50" required>
                </div>
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="closeAddPersonModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Person</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Google Apps Script Configuration
        const GOOGLE_SCRIPT_CONFIG = {
            webAppUrl: 'https://script.google.com/macros/s/AKfycbwVDpMSxFseatWMl2e3y2X1-5Fc7neH_DI5rhTlPOUHdi9KOhKAyho29X13VdTjh9wU/exec' // Replace with your Google Apps Script web app URL
        };

        // Application state
        let selectedMember = null;
        let teamData = {
            members: [
                {
                    id: 1,
                    name: "Ahmed Rahamathulla",
                    role: "Associate",
                    allowance: 25,
                    leaves: []
                }
            ]
        };

        // Initialize the application
        async function init() {
            await loadData();
            renderTeamMembers();
            if (teamData.members.length > 0) {
                selectMember(teamData.members[0].id);
            }
            setupEventListeners();
        }

        // Load data from Google Apps Script only
        async function loadData() {
            if (!GOOGLE_SCRIPT_CONFIG.webAppUrl || GOOGLE_SCRIPT_CONFIG.webAppUrl === 'YOUR_SCRIPT_URL_HERE') {
                console.log('Google Apps Script not configured');
                return;
            }

            try {
                const response = await fetch(GOOGLE_SCRIPT_CONFIG.webAppUrl);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch from Google Apps Script');
                }
                
                const result = await response.json();
                if (result.error) {
                    throw new Error(result.error);
                }
                
                parseGoogleSheetsData(result.data);
                console.log('Data loaded from Google Sheets via Apps Script');
            } catch (error) {
                console.error('Error loading from Google Apps Script:', error);
                alert('Could not load data from Google Sheets. Please check your internet connection.');
            }
        }

        // Parse Google Sheets data
        function parseGoogleSheetsData(rows) {
            if (!rows || rows.length <= 1) return;

            const members = new Map();
            
            // Skip header row
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (row.length < 4) continue;

                const [memberId, memberName, role, allowance, leaveId, startDate, endDate, leaveType, notes, recordedAt] = row;
                
                if (!members.has(memberId)) {
                    members.set(memberId, {
                        id: parseInt(memberId) || Date.now(),
                        name: memberName,
                        role: role,
                        allowance: parseInt(allowance) || 25,
                        leaves: []
                    });
                }

                // Add leave if all leave data is present
                if (leaveId && startDate && endDate && leaveType) {
                    members.get(memberId).leaves.push({
                        id: parseInt(leaveId) || Date.now(),
                        startDate,
                        endDate,
                        type: leaveType,
                        notes: notes || '',
                        recordedAt
                    });
                }
            }

            teamData.members = Array.from(members.values());
        }

        // Fallback to localStorage
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('leaveTrackerData');
                if (savedData) {
                    teamData = JSON.parse(savedData);
                }
            } catch (error) {
                console.log('Could not load from localStorage:', error);
            }
        }

        // Save data to Google Apps Script only
        async function saveData() {
            if (!GOOGLE_SCRIPT_CONFIG.webAppUrl || GOOGLE_SCRIPT_CONFIG.webAppUrl === 'YOUR_SCRIPT_URL_HERE') {
                console.log('Google Apps Script not configured');
                alert('Cannot save data - Google Sheets not configured');
                return;
            }

            try {
                await saveToGoogleScript();
                console.log('Data saved to Google Sheets via Apps Script');
            } catch (error) {
                console.error('Error saving to Google Apps Script:', error);
                alert('Failed to save data to Google Sheets. Please try again.');
            }
        }

        // Save to Google Apps Script
        async function saveToGoogleScript() {
            const rows = [['Member ID', 'Member Name', 'Role', 'Allowance', 'Leave ID', 'Start Date', 'End Date', 'Leave Type', 'Notes', 'Recorded At']];
            
            teamData.members.forEach(member => {
                if (member.leaves.length === 0) {
                    // Add member row even if no leaves
                    rows.push([member.id, member.name, member.role, member.allowance, '', '', '', '', '', '']);
                } else {
                    member.leaves.forEach(leave => {
                        rows.push([
                            member.id,
                            member.name,
                            member.role,
                            member.allowance,
                            leave.id,
                            leave.startDate,
                            leave.endDate,
                            leave.type,
                            leave.notes,
                            leave.recordedAt
                        ]);
                    });
                }
            });

            // Use a form submission approach to avoid CORS
            const form = new FormData();
            form.append('data', JSON.stringify(rows));

            const response = await fetch(GOOGLE_SCRIPT_CONFIG.webAppUrl, {
                method: 'POST',
                body: form
            });

            if (!response.ok) {
                throw new Error('Failed to save to Google Apps Script');
            }

            const result = await response.text();
            try {
                const jsonResult = JSON.parse(result);
                if (jsonResult.error) {
                    throw new Error(jsonResult.error);
                }
            } catch (e) {
                // Response might not be JSON, that's okay
            }
        }

        // Get member initials (first letter of first and last name)
        function getInitials(name) {
            const nameParts = name.trim().split(' ');
            if (nameParts.length === 1) {
                return nameParts[0].charAt(0).toUpperCase();
            }
            return (nameParts[0].charAt(0) + nameParts[nameParts.length - 1].charAt(0)).toUpperCase();
        }

        // Render team members
        function renderTeamMembers() {
            const container = document.getElementById('teamMembers');
            container.innerHTML = '';

            teamData.members.forEach(member => {
                const totalTaken = calculateTotalLeave(member);
                const remaining = member.allowance - totalTaken;
                
                const memberElement = document.createElement('div');
                memberElement.className = `team-member ${selectedMember?.id === member.id ? 'selected' : ''}`;
                memberElement.onclick = () => selectMember(member.id);
                
                memberElement.innerHTML = `
                    <div class="member-info">
                        <div class="avatar">${getInitials(member.name)}</div>
                        <div class="member-details">
                            <h3>${member.name}</h3>
                            <p>${member.role}</p>
                        </div>
                    </div>
                    <div class="leave-stats">
                        <div class="days-left">${remaining}</div>
                        <div class="days-left-label">days left</div>
                    </div>
                `;
                
                container.appendChild(memberElement);
            });
        }

        // Select a team member
        function selectMember(memberId) {
            selectedMember = teamData.members.find(m => m.id === memberId);
            renderTeamMembers();
            updateMemberStats();
            renderLeaveHistory();
        }

        // Update member statistics
        function updateMemberStats() {
            if (!selectedMember) return;

            const totalTaken = calculateTotalLeave(selectedMember);
            const remaining = selectedMember.allowance - totalTaken;
            const usagePercentage = (totalTaken / selectedMember.allowance) * 100;

            document.getElementById('totalAllowance').textContent = selectedMember.allowance;
            document.getElementById('daysTaken').textContent = totalTaken;
            document.getElementById('daysRemaining').textContent = remaining;
            document.getElementById('progressFill').style.width = `${Math.min(usagePercentage, 100)}%`;
            document.getElementById('usagePercentage').textContent = `${Math.round(usagePercentage)}% used`;
        }

        // Calculate business days between two dates (excluding weekends)
        function calculateBusinessDays(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Ensure start is before or equal to end
            if (start > end) return 0;
            
            let businessDays = 0;
            const currentDate = new Date(start);
            
            while (currentDate <= end) {
                const dayOfWeek = currentDate.getDay();
                // 0 = Sunday, 6 = Saturday, so exclude these
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    businessDays++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return businessDays;
        }

        // Calculate total leave days for a member (business days only)
        function calculateTotalLeave(member) {
            return member.leaves.reduce((total, leave) => {
                const businessDays = calculateBusinessDays(leave.startDate, leave.endDate);
                return total + businessDays;
            }, 0);
        }

        // Get leave type icon
        function getLeaveTypeIcon(type) {
            const icons = {
                annual: 'üèñÔ∏è',
                sick: 'ü§í',
                personal: 'üë§',
                maternity: 'üë∂',
                emergency: 'üö®'
            };
            return icons[type] || 'üìÖ';
        }

        // Render leave history
        function renderLeaveHistory() {
            const container = document.getElementById('leaveHistory');
            
            if (!selectedMember || selectedMember.leaves.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <p>No leave records found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            selectedMember.leaves.forEach(leave => {
                const duration = calculateBusinessDays(leave.startDate, leave.endDate);
                
                const leaveElement = document.createElement('div');
                leaveElement.className = 'leave-entry';
                leaveElement.innerHTML = `
                    <div class="leave-info">
                        <div class="leave-type-icon">${getLeaveTypeIcon(leave.type)}</div>
                        <div>
                            <div class="leave-dates">${formatDate(new Date(leave.startDate))} - ${formatDate(new Date(leave.endDate))}</div>
                            <div class="leave-notes">${leave.type.charAt(0).toUpperCase() + leave.type.slice(1)} Leave${leave.notes ? ' ‚Ä¢ ' + leave.notes : ''}</div>
                        </div>
                    </div>
                    <div class="leave-duration">${duration} business day${duration !== 1 ? 's' : ''}</div>
                `;
                container.appendChild(leaveElement);
            });
        }

        // Format date for display
        function formatDate(date) {
            return date.toLocaleDateString('en-US', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('leaveForm').addEventListener('submit', handleLeaveSubmission);
            document.getElementById('addPersonForm').addEventListener('submit', handleAddPerson);
            
            // Auto-update end date when start date changes
            document.getElementById('startDate').addEventListener('change', function() {
                const endDateInput = document.getElementById('endDate');
                if (!endDateInput.value || endDateInput.value < this.value) {
                    endDateInput.value = this.value;
                }
                endDateInput.min = this.value;
            });
        }

        // Handle leave form submission
        async function handleLeaveSubmission(e) {
            e.preventDefault();
            
            if (!selectedMember) {
                alert('Please select a team member first');
                return;
            }

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const leaveType = document.getElementById('leaveType').value;
            const notes = document.getElementById('notes').value;

            const newLeave = {
                id: Date.now(),
                startDate,
                endDate,
                type: leaveType,
                notes,
                recordedAt: new Date().toISOString()
            };

            selectedMember.leaves.push(newLeave);
            await saveData();
            updateMemberStats();
            renderLeaveHistory();
            clearForm();
        }

        // Clear the leave form
        function clearForm() {
            document.getElementById('leaveForm').reset();
        }

        // Add person modal functions
        function openAddPersonModal() {
            document.getElementById('addPersonModal').style.display = 'block';
        }

        function closeAddPersonModal() {
            document.getElementById('addPersonModal').style.display = 'none';
            document.getElementById('addPersonForm').reset();
        }

        // Handle add person form submission
        async function handleAddPerson(e) {
            e.preventDefault();
            
            const name = document.getElementById('personName').value;
            const role = document.getElementById('personRole').value;
            const allowance = parseInt(document.getElementById('annualAllowance').value);

            const newMember = {
                id: Date.now(),
                name,
                role,
                allowance,
                leaves: []
            };

            teamData.members.push(newMember);
            await saveData();
            renderTeamMembers();
            selectMember(newMember.id);
            closeAddPersonModal();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('addPersonModal');
            if (event.target === modal) {
                closeAddPersonModal();
            }
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
